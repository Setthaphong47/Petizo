<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á - Petizo</title>
    
    <!-- ‚ö° Preload Critical Resources -->
    <link rel="preload" href="/css/navbar.css" as="style">
    <link rel="preload" href="/js/navbar.js" as="script">
    <link rel="preload" href="/icon/cat.png" as="image">
    
    <!-- üé® Navbar CSS -->
    <link rel="stylesheet" href="/css/navbar.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 40px;
        }

        /* Pet Header */
        .pet-header {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: flex;
            gap: 30px;
        }

        .pet-photo-large {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00bcd4 0%, #00e5ff 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .pet-photo-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .pet-info-full {
            flex: 1;
        }

        .pet-name-large {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            margin-bottom: 16px;
        }

        .pet-details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .detail-row {
            display: flex;
            gap: 8px;
            font-size: 16px;
            color: #666;
        }

        .detail-label {
            font-weight: 600;
            color: #333;
        }

        /* Section */
        .section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            padding: 12px 24px;
            background: linear-gradient(135deg, #00bcd4 0%, #00e5ff 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 188, 212, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 188, 212, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            padding: 12px 24px;
            background: white;
            color: #00bcd4;
            border: 2px solid #00bcd4;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: #00bcd4;
            color: white;
        }

        /* Vaccine Timeline */
        .vaccine-timeline {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .vaccine-item {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .vaccine-item.completed {
            border-color: #52c41a;
            background: #f6ffed;
        }

        .vaccine-item.due {
            border-color: #faad14;
            background: #fffbf0;
        }

        .vaccine-item.overdue {
            border-color: #ff4d4f;
            background: #fff1f0;
        }

        .vaccine-item.upcoming {
            border-color: #d9d9d9;
            background: #fafafa;
        }

        .vaccine-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .vaccine-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .vaccine-status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .badge-completed {
            background: #d4edda;
            color: #155724;
        }

        .badge-due {
            background: #fff3cd;
            color: #856404;
        }

        .badge-overdue {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-upcoming {
            background: #e2e3e5;
            color: #6c757d;
        }

        .vaccine-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            color: #666;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .vaccine-description {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
            padding: 12px;
            background: rgba(0, 188, 212, 0.05);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .vaccine-actions {
            display: flex;
            gap: 10px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
        }

        .btn-record {
            padding: 8px 16px;
            background: #00bcd4;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-record:hover {
            background: #00acc1;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* Pet Age Info */
        .pet-age-info {
            background: #e0f7fa;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 15px;
            color: #00695c;
            font-weight: 500;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 680px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #00bcd4 0%, #00e5ff 100%);
            color: white;
            border-radius: 16px 16px 0 0;
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: 700;
        }

        .close-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 16px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e8eaed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.18s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #00bcd4;
            box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.1);
        }

        .form-group small {
            display: block;
            margin-top: 6px;
            color: #999;
            font-size: 13px;
        }

        .form-error {
            color: #ff4d4f;
            font-size: 13px;
            margin-top: 6px;
            display: none;
        }

        .form-group.error input,
        .form-group.error textarea,
        .form-group.error select {
            border-color: #ff4d4f;
        }

        .form-group.error .form-error {
            display: block;
        }

        /* Image Upload Area */
        .upload-area {
            border: 3px dashed #d0d0d0;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
            background: #fafafa;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #00bcd4;
            background: #f0f9fa;
        }

        .upload-area.dragover {
            border-color: #00bcd4;
            background: #e0f7fa;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .upload-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .upload-text {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }

        /* Form grid: two columns for modal form */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            align-items: start;
        }

        /* Force record vaccination modal to single-column (vertical) layout */
        #recordVaccineModal .form-grid {
            grid-template-columns: 1fr !important;
            gap: 14px;
        }

        /* Stronger override: use flex column to guarantee vertical stacking */
        #recordVaccineModal .form-grid {
            display: flex !important;
            flex-direction: column !important;
            align-items: stretch !important;
        }

        /* Make the two column containers occupy full width when stacked */
        #recordVaccineModal .form-grid > div {
            width: 100% !important;
            box-sizing: border-box;
        }

        /* Ensure upload block and preview fill modal width */
        #recordVaccineModal .upload-block,
        #recordVaccineModal .upload-area.large,
        #recordVaccineModal .image-preview-container {
            width: 100% !important;
        }

        .section-subtitle {
            font-size: 14px;
            font-weight: 700;
            color: #333;
            margin: 8px 0 12px 0;
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(0, 188, 212, 0.06);
            border-left: 3px solid rgba(0,188,212,0.15);
        }

        /* Larger upload area variant */
        .upload-area.large {
            padding: 22px 18px;
            min-height: 140px;
        }

        /* Preview image bordered card */
        .image-preview.bordered {
            border: 1px solid #e6e6e6;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            padding: 8px;
            background: white;
            width: 220px;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* When preview is inside upload box */
        .upload-area.large {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .upload-area.large.has-image .upload-icon,
        .upload-area.large.has-image .upload-title,
        .upload-area.large.has-image .upload-text,
        .upload-area.large.has-image small {
            display: none;
        }

        .upload-area.large .image-preview.bordered {
            width: 100%;
            height: 160px;
            padding: 6px;
            box-shadow: none;
            border-radius: 10px;
            background: #fff;
        }

        /* Make upload area use full width when inside modal so preview sits inside box */
        #recordVaccineModal .upload-area.large {
            width: 100%;
            box-sizing: border-box;
        }

        .upload-area.large .image-preview.bordered img {
            width: auto;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            cursor: default;
        }

        /* Button hierarchy */
        .btn-upload {
            padding: 8px 18px;
            border: none;
            border-radius: 20px;
            background: #e3f2fd; /* lighter blue */
            color: #0288d1;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid rgba(2,136,209,0.12);
        }

        .btn-upload:hover { transform: translateY(-2px); }

        .btn-delete {
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            background: #ff4d4f;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-save {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 10px;
            background: linear-gradient(135deg,#0277bd 0%,#01579b 100%);
            color: #fff;
            border: none;
            box-shadow: 0 6px 18px rgba(2,119,189,0.14);
        }

        .btn-save:hover { transform: translateY(-2px); }

        /* Notes textarea: smaller default height, allow vertical resize */
        textarea#recordNotes {
            min-height: 80px;
            max-height: 300px;
            resize: vertical;
        }

        /* Image Preview */
        .image-preview-container {
            margin-top: 16px;
            display: none;
        }

        .image-preview-container.active {
            display: block;
        }

        .image-preview {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .image-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            background: white;
        }

        /* Thumbnail preview: preserve small images, contain large images */
        .image-preview.bordered img {
            width: auto;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
            cursor: zoom-in;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            justify-content: center;
        }

        /* OCR suggestions panel */
        .ocr-suggestions {
            margin-top: 14px;
            padding: 12px;
            border-radius: 10px;
            background: linear-gradient(135deg,#ffffff 0%,#f7f9fb 100%);
            border: 1px solid #e6eef6;
            box-shadow: 0 6px 18px rgba(2,119,189,0.04);
        }

        .ocr-suggestions .ocr-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:8px;
        }

        .ocr-suggestions .ocr-body { display:block; }

        .ocr-suggestions .ocr-row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }

        .ocr-suggestions label { min-width:140px; font-size:13px; color:#333; }

        .ocr-suggestions input { flex:1; padding:8px 10px; border-radius:8px; border:1px solid #e0e6ef; }

        .confidence-badge {
            background: #fff;
            border-radius: 12px;
            padding: 6px 10px;
            font-weight:700;
            color:#1976d2;
            border:1px solid rgba(25,118,210,0.12);
            font-size:13px;
        }

        .close-ocr { background:transparent;border:none;font-size:14px;cursor:pointer;color:#666 }

        .hidden { display:none !important; }

        .btn-change,
        .btn-remove {
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-change {
            background: #00bcd4;
            color: white;
        }

        .btn-change:hover {
            background: #00acc1;
            transform: translateY(-2px);
        }

        .btn-remove {
            background: #ff4d4f;
            color: white;
        }

        .btn-remove:hover {
            background: #ff1f1f;
            transform: translateY(-2px);
        }

        /* Enhancement Controls - HIDDEN */
        .enhancement-controls {
            display: none !important;
        }

        /* OCR Processing */
        .ocr-processing {
            margin-top: 16px;
            padding: 16px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 12px;
            border-left: 4px solid #2196f3;
            display: none;
        }

        .ocr-processing.active {
            display: block;
        }

        .processing-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #e0e0e0;
            border-top-color: #2196f3;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .processing-text {
            font-size: 14px;
            font-weight: 600;
            color: #1976d2;
        }

        .processing-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            font-size: 13px;
        }

        .step-status {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .step-status.pending { color: #ccc; }
        .step-status.active { color: #2196f3; }
        .step-status.done { color: #4caf50; }

        /* OCR Result */
        .ocr-result {
            margin-top: 16px;
            padding: 16px;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 12px;
            border-left: 4px solid #4caf50;
            display: none;
        }

        .ocr-result.active {
            display: block;
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .result-icon {
            font-size: 20px;
        }

        .result-title {
            font-size: 14px;
            font-weight: 600;
            color: #1b5e20;
            flex: 1;
        }

        .confidence-badge {
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: #4caf50;
        }

        .vaccine-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .vaccine-tag {
            background: white;
            color: #00bcd4;
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            border: 2px solid #00bcd4;
        }

        .extracted-data {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .data-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #00bcd4;
            position: relative;
        }

        .data-item:last-child {
            margin-bottom: 0;
        }

        .data-row {
            display: flex;
            align-items: start;
            gap: 8px;
        }

        .data-icon {
            font-size: 18px;
            min-width: 24px;
        }

        .data-content {
            flex: 1;
        }

        .data-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }

        .data-value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            line-height: 1.4;
        }

        .btn-edit-field {
            padding: 4px 12px;
            background: #00bcd4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-edit-field:hover {
            background: #00acc1;
            transform: translateY(-1px);
        }

        .result-actions {
            display: flex;
            gap: 8px;
        }

        .btn-auto-fill {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: #4caf50;
            color: white;
        }

        .btn-auto-fill:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            transition: top 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 500px;
        }

        .toast.show {
            top: 20px;
        }

        .toast-success {
            border-left: 4px solid #52c41a;
        }

        .toast-success::before {
            content: "‚úÖ";
            font-size: 20px;
        }

        .toast-error {
            border-left: 4px solid #ff4d4f;
        }

        .toast-error::before {
            content: "‚ùå";
            font-size: 20px;
        }

        .toast-warning {
            border-left: 4px solid #faad14;
        }

        .toast-warning::before {
            content: "‚ö†Ô∏è";
            font-size: 20px;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00bcd4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .pet-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .pet-details-grid {
                grid-template-columns: 1fr;
            }

            .vaccine-details {
                grid-template-columns: 1fr;
            }

            .navbar {
                padding: 16px 20px;
            }

            .container {
                padding: 0 20px;
            }

            .modal-content {
                margin: 20px;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Navbar -->
    <div id="navbar-container"></div>

    <!-- Container -->
    <div class="container">
        <!-- Back Button -->
        <div style="margin-bottom: 20px;">
            <button class="btn-back" onclick="goBack()" style="padding: 10px 20px; background: #f0f0f0; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;">
                ‚Üê ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
            </button>
        </div>

        <!-- Pet Header -->
        <div class="pet-header" id="petHeader">
            <div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        </div>

        <!-- Vaccination Section -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">
                    <span style="font-size: 32px;">üíâ</span> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
                </h2>
                <div style="display: flex; gap: 12px;">
                    <button class="btn-secondary" onclick="viewVaccinationRecord()">
                        <span style="font-size: 20px;">üìñ</span> ‡∏î‡∏π‡∏™‡∏°‡∏∏‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô
                    </button>
                </div>
            </div>

            <!-- Pet Age Info -->
            <div id="petAgeInfo" class="pet-age-info" style="display: none;">
                <strong>‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ç‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏á:</strong> <span id="petAgeText"></span>
            </div>

            <!-- Vaccine Timeline -->
            <div id="vaccineTimeline">
                <div class="empty-state">
                    <div class="empty-state-icon">‚è≥</div>
                    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Record Vaccination Modal -->
    <div id="recordVaccineModal" class="modal" role="dialog" aria-labelledby="modalTitle" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">üíâ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</h2>
                <button class="close-btn" onclick="closeRecordVaccineModal()" aria-label="‡∏õ‡∏¥‡∏î">&times;</button>
            </div>
            <div class="modal-body">
                <form id="recordVaccineForm" onsubmit="handleRecordVaccination(event)">
                    <input type="hidden" id="recordScheduleId">
                    <input type="hidden" id="expectedVaccineName">

                    <div class="form-grid">
                        <div>
                            <div class="section-subtitle">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</div>
                            <div class="form-group">
                                <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô *</label>
                                <input type="text" id="recordVaccineName" required readonly style="background: #f5f5f5;">
                            </div>

                            <div class="form-group">
                                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏â‡∏µ‡∏î‡∏à‡∏£‡∏¥‡∏á *</label>
                                <input type="date" id="recordVaccinationDate" required>
                                <span class="form-error">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>
                            </div>

                            <div class="form-group">
                                <label>Batch Number</label>
                                <input type="text" id="recordBatchNumber" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Batch" maxlength="50">
                            </div>
                            <div class="form-group">
                                <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏¥‡∏ï</label>
                                <input type="date" id="recordManufactureDate" placeholder="‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ">
                            </div>

                            <div class="form-group">
                                <label>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label>
                                <input type="date" id="recordExpiryDate" placeholder="‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ">
                            </div>
                        </div>

                        <div>
                            <div class="section-subtitle">‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
                            <div class="form-group">
                                <label>‡∏™‡∏±‡∏ï‡∏ß‡πÅ‡∏û‡∏ó‡∏¢‡πå</label>
                                <input type="text" id="recordVeterinarian" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πÅ‡∏û‡∏ó‡∏¢‡πå" maxlength="100">
                            </div>
                            <div class="form-group">
                                <label>‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å/‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</label>
                                <input type="text" id="recordClinicName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å" maxlength="100">
                            </div>

                            <div class="section-subtitle">‡∏£‡∏π‡∏õ‡∏â‡∏•‡∏≤‡∏Å‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</div>
                            <div class="form-group upload-block">
                                <input type="file" id="recordProofImage" accept="image/jpeg,image/jpg,image/png" required onchange="handleFileSelect(event)" style="display: none;">

                                <div class="upload-area large" id="uploadArea" onclick="document.getElementById('recordProofImage').click()">
                                    <div class="upload-icon" style="font-size:40px;">üì∑</div>
                                    <h4 class="upload-title">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏â‡∏•‡∏≤‡∏Å‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</h4>
                                    <p class="upload-text">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏â‡∏•‡∏≤‡∏Å‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                                    <small>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: JPG, PNG (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB)</small>

                                    <!-- Image Preview (now nested inside upload area so CSS containment applies) -->
                                    <div id="imagePreviewContainer" class="image-preview-container">
                                        <div class="image-preview bordered">
                                            <img id="previewImg" src="" alt="Preview" onclick="openPreview()" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢">
                                        </div>
                                        <div class="preview-actions">
                                            <button type="button" class="btn-upload" onclick="document.getElementById('recordProofImage').click()">
                                                üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ
                                            </button>
                                            <button type="button" class="btn-upload" id="ocrButton" onclick="triggerOCR()" title="‡∏≠‡πà‡∏≤‡∏ô‡∏â‡∏•‡∏≤‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥">
                                                üîé ‡∏≠‡πà‡∏≤‡∏ô‡∏â‡∏•‡∏≤‡∏Å
                                            </button>
                                            <button type="button" class="btn-delete" onclick="removeImage()">
                                                üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏π‡∏õ
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <span class="form-error">‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>

                                <!-- OCR Suggestions Panel (hidden until results) -->
                                <div id="ocrSuggestions" class="ocr-suggestions hidden" aria-live="polite">
                                    <div class="ocr-header">
                                        <strong>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏à‡∏≤‡∏Å OCR</strong>
                                        <button type="button" class="close-ocr" onclick="closeOCRSuggestions()">‚úñ</button>
                                    </div>
                                    <div class="ocr-body">
                                        <div class="ocr-row">
                                            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô (‡πÄ‡∏™‡∏ô‡∏≠):</label>
                                            <input type="text" id="ocrVaccineName" placeholder="‚Äî" />
                                            <span id="ocrConfidence" class="confidence-badge">0%</span>
                                        </div>
                                        <div class="ocr-row">
                                            <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Batch (‡πÄ‡∏™‡∏ô‡∏≠):</label>
                                            <input type="text" id="ocrBatchNumber" placeholder="‚Äî" />
                                        </div>
                                        <div class="ocr-row">
                                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏¥‡∏ï (‡πÄ‡∏™‡∏ô‡∏≠):</label>
                                            <input type="text" id="ocrManufactureDate" placeholder="dd/mm/yyyy" />
                                        </div>
                                        <div class="ocr-row">
                                            <label>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÄ‡∏™‡∏ô‡∏≠):</label>
                                            <input type="text" id="ocrExpiryDate" placeholder="dd/mm/yyyy" />
                                        </div>
                                        <div style="display:flex;gap:8px;margin-top:12px;">
                                            <button type="button" class="btn-upload" onclick="applyOCRSuggestions()">‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÉ‡∏ä‡πâ</button>
                                            <button type="button" class="btn-change" onclick="closeOCRSuggestions()">‡∏õ‡∏¥‡∏î</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="section-subtitle">‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</div>
                            <div class="form-group">
                                <label>‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</label>
                                <input type="date" id="recordNextDueDate">
                                <small style="display:block;color:#666;margin-top:6px;font-size:13px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏â‡∏µ‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea id="recordNotes" rows="4" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" maxlength="2000"></textarea>
                    </div>

                    <button type="submit" class="btn-primary btn-save" id="submitBtn">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="./js/config.js"></script>
    <script>
        // Constants
        const API_URL = CONFIG ? CONFIG.API_URL : 'http://localhost:3000/api';
        // OCR disabled flag ‚Äî client-side OCR removed per request
        const OCR_DISABLED = true;
        const MAX_FILE_SIZE = 5 * 1024 * 1024;
        const MAX_DISPLAY_VACCINES = 5;
        const WEEKS_PER_YEAR = 52;
        const WEEKS_PER_MONTH = 4;
        const ALLOWED_FILE_TYPES = ['image/jpeg', 'image/jpg', 'image/png'];
        
        let currentPetId = null;
        let currentPet = null;
        let recommendedVaccines = [];
        let currentImageFile = null;

        // ===== VACCINE NAME MAPPING =====
        const VACCINE_NAME_MAPPING = {
            'RABIES': ['Rabies Vaccine', 'Defensor 3', 'Nobivac Rabies', 'Defensor'],
            'DEFENSOR': ['Rabies Vaccine', 'Defensor 3'],
            'DEFENSOR 3': ['Rabies Vaccine'],
            'NOBIVAC RABIES': ['Rabies Vaccine'],
            'FVRCP': ['Feline Rhinotracheitis-Calici-Panleukopenia-Chlamydia Psittaci Vaccine', 'Felocell 4', 'Nobivac Tricat', 'Felocell'],
            'FELOCELL': ['Feline Rhinotracheitis-Calici-Panleukopenia-Chlamydia Psittaci Vaccine', 'Felocell 4'],
            'FELOCELL 4': ['Feline Rhinotracheitis-Calici-Panleukopenia-Chlamydia Psittaci Vaccine'],
            'NOBIVAC TRICAT': ['Feline Rhinotracheitis-Calici-Panleukopenia Vaccine']
        };

        function normalizeVaccineName(name) {
            if (!name) return '';
            return name.toLowerCase()
                .replace(/\s+/g, ' ')
                .replace(/[-_]/g, ' ')
                .replace(/psittaci/i, '')
                .replace(/chlamydia/i, '')
                .trim();
        }

        function vaccineNamesMatch(name1, name2) {
            if (!name1 || !name2) return false;
            
            const norm1 = normalizeVaccineName(name1);
            const norm2 = normalizeVaccineName(name2);
            
            if (norm1 === norm2) return true;
            if (norm1.includes(norm2) || norm2.includes(norm1)) return true;
            
            for (const [shortName, fullNames] of Object.entries(VACCINE_NAME_MAPPING)) {
                const normShort = normalizeVaccineName(shortName);
                
                if (norm1.includes(normShort) || normShort.includes(norm1)) {
                    for (const fullName of fullNames) {
                        const normFull = normalizeVaccineName(fullName);
                        if (norm2.includes(normFull) || normFull.includes(norm2)) {
                            return true;
                        }
                    }
                }
                
                if (norm2.includes(normShort) || normShort.includes(norm2)) {
                    for (const fullName of fullNames) {
                        const normFull = normalizeVaccineName(fullName);
                        if (norm1.includes(normFull) || normFull.includes(norm1)) {
                            return true;
                        }
                    }
                }
            }
            
            const keywords1 = new Set(norm1.split(' ').filter(w => w.length > 3));
            const keywords2 = new Set(norm2.split(' ').filter(w => w.length > 3));
            const intersection = [...keywords1].filter(x => keywords2.has(x));
            const matchRatio = intersection.length / Math.min(keywords1.size, keywords2.size);
            
            if (matchRatio >= 0.6) {
                return true;
            }

            return false;
        }

        function getStandardVaccineName(detectedName, fullText) {
            if (/rabies/i.test(detectedName) || /rabies/i.test(fullText)) {
                return 'Rabies Vaccine';
            }
            
            if (/felocell/i.test(detectedName) || /felocell/i.test(fullText)) {
                if (/chlamydia/i.test(fullText) || /psittaci/i.test(fullText)) {
                    return 'Feline Rhinotracheitis-Calici-Panleukopenia-Chlamydia Psittaci Vaccine';
                }
            }
            
            if (/feline.*rhinotracheitis/i.test(fullText)) {
                if (/chlamydia/i.test(fullText) || /psittaci/i.test(fullText)) {
                    return 'Feline Rhinotracheitis-Calici-Panleukopenia-Chlamydia Psittaci Vaccine';
                } else {
                    return 'Feline Rhinotracheitis-Calici-Panleukopenia Vaccine';
                }
            }
            
            return detectedName;
        }

        // ===== VACCINE TEMPLATES =====
        const VACCINE_TEMPLATES = {
            'FELOCELL_4': {
                brand: 'Zoetis',
                name: 'Felocell 4',
                color_scheme: 'white_left_black_right',
                layout_type: 'split_vertical',
                
                regions: {
                    main_info: {
                        x_percent: 0,
                        y_percent: 0,
                        width_percent: 60,
                        height_percent: 100,
                        fields: [
                            { name: 'dosage', pattern: /(\d+)\s*dose/i, y_range: [0, 15] },
                            { name: 'rehydrate', pattern: /Rehydrate\s+to\s+([\d\.]+\s*m[Ll])/i, y_range: [0, 15] },
                            { name: 'vaccine_type', pattern: /Feline\s+Rhinotracheitis.*?Vaccine/is, y_range: [10, 40] },
                            { name: 'virus_type', pattern: /Modified\s+Live\s+(?:Virus|Chlamydia)/gi, y_range: [35, 55] },
                            { name: 'license', pattern: /U\.?S\.?\s+Veterinary\s+License\s+No\.?\s*(\d+)/i, y_range: [50, 65] },
                            { name: 'manufacturer', pattern: /Manufactured\s+by:?\s*([^\n]+(?:\n[^\n]+)?)/i, y_range: [60, 80] },
                            { name: 'trade_name', pattern: /FELOCELL/i, y_range: [85, 100] }
                        ]
                    },
                    
                    batch_info: {
                        x_percent: 60,
                        y_percent: 0,
                        width_percent: 40,
                        height_percent: 100,
                        background: 'dark',
                        fields: [
                            { name: 'reg_no', pattern: /REG\s+NO\.?\s*[:\s]*([A-Z0-9\/\-\(\)\s]+)/i, y_range: [0, 25] },
                            { name: 'serial', pattern: /SER[:\s]*([A-Z0-9]+)/i, y_range: [20, 45] },
                            { name: 'manufacture_date', pattern: /MFG[:\s]*(\d{1,2}\s+[A-Z]{3}\s+\d{2,4})/i, y_range: [40, 70] },
                            { name: 'expiry_date', pattern: /EXP[:\s]*(\d{1,2}\s+[A-Z]{3}\s+\d{2,4})/i, y_range: [65, 100] }
                        ]
                    }
                },
                
                field_weights: {
                    'vaccine_type': 1.0,
                    'serial': 0.95,
                    'expiry_date': 0.95,
                    'manufacture_date': 0.90,
                    'license': 0.85,
                    'manufacturer': 0.85,
                    'reg_no': 0.80
                }
            },
            
            'DEFENSOR_3': {
                brand: 'Zoetis',
                name: 'Defensor 3',
                color_scheme: 'white_left_black_right',
                layout_type: 'split_vertical',
                
                regions: {
                    main_info: {
                        x_percent: 0,
                        y_percent: 0,
                        width_percent: 65,
                        height_percent: 100,
                        fields: [
                            { name: 'dosage', pattern: /(\d+)\s*dose/i, y_range: [0, 12] },
                            { name: 'volume', pattern: /(\d+)\s*ml/i, y_range: [0, 12] },
                            { name: 'vaccine_name', pattern: /Rabies\s+Vaccine/i, y_range: [18, 32] },
                            { name: 'virus_type', pattern: /Killed\s+Virus/i, y_range: [30, 42] },
                            { name: 'usage', pattern: /For\s+use\s+in\s+dogs,\s+cats,.*?only/is, y_range: [38, 58] },
                            { name: 'reg_no', pattern: /Reg\s+No\.?\s*([A-Z0-9\/\-\(\)\s]+)/i, y_range: [65, 78] },
                            { name: 'manufacturer', pattern: /Zoetis\s+Inc\./i, y_range: [75, 88] },
                            { name: 'trade_name', pattern: /DEFENSOR/i, y_range: [85, 100] }
                        ]
                    },
                    
                    batch_info: {
                        x_percent: 65,
                        y_percent: 0,
                        width_percent: 35,
                        height_percent: 100,
                        background: 'dark',
                        fields: [
                            { name: 'serial', pattern: /([A-Z0-9]{5,})/i, y_range: [0, 35], context: 'first_number' },
                            { name: 'manufacture_date', pattern: /(\d{1,2}\s+[A-Z]{3}\s+\d{2,4})/i, y_range: [30, 65], context: 'first_date' },
                            { name: 'expiry_date', pattern: /(\d{1,2}\s+[A-Z]{3}\s+\d{2,4})/i, y_range: [60, 100], context: 'second_date' }
                        ]
                    }
                },
                
                field_weights: {
                    'vaccine_name': 1.0,
                    'serial': 0.95,
                    'expiry_date': 0.95,
                    'manufacture_date': 0.90,
                    'virus_type': 0.88,
                    'reg_no': 0.85
                }
            }
        };

        function detectVaccineTemplate(text) {
            if (/FELOCELL/i.test(text) && /Rhinotracheitis.*Calici.*Panleukopenia/is.test(text)) {
                return VACCINE_TEMPLATES['FELOCELL_4'];
            }

            if (/DEFENSOR/i.test(text) && /Rabies\s+Vaccine/i.test(text)) {
                return VACCINE_TEMPLATES['DEFENSOR_3'];
            }

            if (/ZOETIS/i.test(text)) {
                if (/Rabies/i.test(text)) {
                    return VACCINE_TEMPLATES['DEFENSOR_3'];
                } else if (/Feline/i.test(text)) {
                    return VACCINE_TEMPLATES['FELOCELL_4'];
                }
            }

            return null;
        }

        function extractFieldFromText(text, field, region) {
            try {
                let searchText = text;
                
                if (field.y_range) {
                    const lines = text.split('\n');
                    const totalLines = lines.length;
                    const startLine = Math.floor((field.y_range[0] / 100) * totalLines);
                    const endLine = Math.ceil((field.y_range[1] / 100) * totalLines);
                    searchText = lines.slice(startLine, endLine).join('\n');
                }
                
                const match = searchText.match(field.pattern);
                
                if (match) {
                    return match[1] ? match[1].trim() : match[0].trim();
                }
                
                if (region.background === 'dark' && field.context) {
                    return extractByContext(searchText, field.context);
                }
                
                return null;
                
            } catch (error) {
                console.error(`Error extracting ${field.name}:`, error);
                return null;
            }
        }

        function extractByContext(text, context) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            
            switch (context) {
                case 'first_number':
                    for (const line of lines) {
                        const match = line.match(/[A-Z0-9]{5,}/i);
                        if (match) return match[0];
                    }
                    break;
                    
                case 'first_date':
                    for (const line of lines) {
                        const match = line.match(/\d{1,2}\s+[A-Z]{3}\s+\d{2,4}/i);
                        if (match) return match[0];
                    }
                    break;
                    
                case 'second_date':
                    let foundFirst = false;
                    for (const line of lines) {
                        const match = line.match(/\d{1,2}\s+[A-Z]{3}\s+\d{2,4}/i);
                        if (match) {
                            if (foundFirst) return match[0];
                            foundFirst = true;
                        }
                    }
                    break;
            }
            
            return null;
        }

        function mapFieldName(fieldName) {
            const mapping = {
                'vaccine_type': 'vaccine_type',
                'vaccine_name': 'vaccine_name',
                'trade_name': 'trade_name',
                'virus_type': 'virus_type',
                'manufacturer': 'manufacturer',
                'license': 'license_no',
                'reg_no': 'registration_no',
                'serial': 'serial_number',
                'manufacture_date': 'manufacture_date',
                'expiry_date': 'expiry_date',
                'dosage': 'dosage',
                'volume': 'volume',
                'rehydrate': 'dosage',
                'usage': 'usage_note'
            };
            
            return mapping[fieldName] || fieldName;
        }

        // ===== OCR and image-processing code removed =====
        // Client-side OCR and related image-processing functions were removed
        // to allow migrating OCR to a server-side service. If you need to
        // restore client-side OCR, re-add the functions from the previous
        // implementation or call your OCR microservice from `handleFileSelect`.
        function createDetailedNotes(data) {
            let notes = 'üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô OCR\n';
            notes += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n';
            
            notes += 'üíâ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô:\n';
            if (data.vaccine_name) notes += `  ‚Ä¢ ‡∏ä‡∏∑‡πà‡∏≠: ${data.vaccine_name}\n`;
            if (data.trade_name) notes += `  ‚Ä¢ ‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠: ${data.trade_name}\n`;
            if (data.vaccine_type) notes += `  ‚Ä¢ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${data.vaccine_type}\n`;
            if (data.virus_type) notes += `  ‚Ä¢ ‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠: ${data.virus_type}\n`;
            if (data.dosage) notes += `  ‚Ä¢ ‡∏Ç‡∏ô‡∏≤‡∏î: ${data.dosage}\n`;
            notes += '\n';
            
            if (data.manufacturer || data.license_no || data.registration_no) {
                notes += 'üè≠ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï:\n';
                if (data.manufacturer) notes += `  ‚Ä¢ ‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï: ${data.manufacturer}\n`;
                if (data.license_no) notes += `  ‚Ä¢ ‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï: ${data.license_no}\n`;
                if (data.registration_no) notes += `  ‚Ä¢ REG NO.: ${data.registration_no}\n`;
                notes += '\n';
            }
            
            if (data.serial_number || data.manufacture_date || data.expiry_date) {
                notes += 'üî¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Batch:\n';
                if (data.serial_number) notes += `  ‚Ä¢ Ser (Batch Number): ${data.serial_number}\n`;
                if (data.manufacture_date) notes += `  ‚Ä¢ Mfg.: ${data.manufacture_date}\n`;
                if (data.expiry_date) notes += `  ‚Ä¢ Exp.: ${data.expiry_date}\n`;
                notes += '\n';
            }
            
            notes += `üìä ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: ${data.confidence}%\n`;
            if (data.template_used) {
                notes += `üéØ Template: ${data.template_used}\n`;
            }
            notes += '\n';
            
            notes += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
            notes += 'üìù ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ:\n';
            notes += data.raw_text.substring(0, 500);
            if (data.raw_text.length > 500) notes += '...';
            
            return notes;
        }

        function validateExtraction(analysis) {
            const expectedVaccine = document.getElementById('expectedVaccineName').value;
            
            const validation = {
                isValid: true,
                warnings: [],
                suggestions: [],
                nameMatch: false
            };
            
            if (!analysis.vaccine_name) {
                validation.warnings.push('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô');
                validation.suggestions.push('‡∏•‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô');
                validation.isValid = false;
            } 
            else if (expectedVaccine) {
                const isMatch = vaccineNamesMatch(analysis.vaccine_name, expectedVaccine);
                validation.nameMatch = isMatch;
                
                if (!isMatch) {
                    validation.warnings.push(`‚ö†Ô∏è ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°`);
                    validation.suggestions.push(
                        `‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏£‡∏∞‡∏ö‡∏∏: "${expectedVaccine}" | ` +
                        `‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö: "${analysis.vaccine_name}"`
                    );
                } else {
                    // Name matches expected vaccine - no debug log
                }
            }
            
            if (!analysis.serial_number && !analysis.batch_number) {
                validation.warnings.push('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Serial/Batch');
                validation.suggestions.push('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Ser ‡∏´‡∏£‡∏∑‡∏≠ LOT ‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà');
            }
            
            if (analysis.confidence < 50) {
                validation.isValid = false;
                validation.warnings.push('‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≥');
                validation.suggestions.push('‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏™‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà');
            }
            
            return validation;
        }

        // Analyze image with server-side OCR
        async function analyzeImageWithOCR(file) {
            if (OCR_DISABLED) {
                showToast('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå OCR ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'warning');
                return null;
            }

            const proc = document.getElementById('ocrProcessing');
            const resultBox = document.getElementById('ocrResult');
            try {
                if (proc) proc.classList.add('active');
                if (resultBox) resultBox.classList.remove('active');

                const fd = new FormData();
                fd.append('file', file);
                fd.append('params', JSON.stringify({ scale: 7 }));

                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 30000);

                const resp = await fetch(OCR_SERVER_URL, {
                    method: 'POST',
                    body: fd,
                    signal: controller.signal
                });
                clearTimeout(timeout);

                if (!resp.ok) {
                    const txt = await resp.text().catch(() => null);
                    throw new Error(`OCR server error: ${resp.status} ${txt || ''}`);
                }

                const json = await resp.json();

                const merged = json.data || json.merged || (json.data && json.data.data) || {};
                const left_text = json.left_text || json.tesseract_left || '';
                const right_text = json.right_text || json.tesseract_right || '';
                const raw_text = [left_text, right_text, json.raw_text, json.formatted_output].filter(Boolean).join('\n\n');

                const confidence = (json.merge_quality && json.merge_quality.merged_accuracy) || json.merged_accuracy || json.accuracy || 0;

                const result = {
                    vaccine_name: merged.vaccine_name || merged.product_name || merged.trade_name || '',
                    trade_name: merged.product_name || merged.trade_name || '',
                    manufacturer: merged.manufacturer || '',
                    registration_no: merged.registration_number || merged.registration_no || '',
                    serial_number: merged.serial_number || merged.ser || '',
                    manufacture_date: merged.mfg_date || merged.manufacture_date || '',
                    expiry_date: merged.exp_date || merged.expiry_date || '',
                    raw_text: raw_text,
                    confidence: Math.round(Number(confidence) || 0),
                    template_used: json.template_used || json.template || null,
                    sources: json.sources || null,
                    _raw_response: json
                };

                aiAnalysisResult = result;

                const validation = validateExtraction(result);
                displayOCRResult(result, validation);

                return result;
            } catch (err) {
                console.error('analyzeImageWithOCR failed', err);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• OCR ‡πÑ‡∏î‡πâ', 'error');
                throw err;
            } finally {
                if (proc) proc.classList.remove('active');
            }
        }

        // ===== DISPLAY OCR RESULT - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß =====
        function displayOCRResult(result, validation) {
            const confidenceBadge = document.getElementById('confidenceBadge');
            confidenceBadge.textContent = `${result.confidence}%`;
            
            if (result.confidence >= 80) {
                confidenceBadge.style.background = 'linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%)';
                confidenceBadge.style.color = '#2e7d32';
            } else if (result.confidence >= 60) {
                confidenceBadge.style.background = 'linear-gradient(135deg, #fff9c4 0%, #fff59d 100%)';
                confidenceBadge.style.color = '#f57f17';
            } else {
                confidenceBadge.style.background = 'linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%)';
                confidenceBadge.style.color = '#c62828';
            }

            const tagsContainer = document.getElementById('vaccineTags');
            const dataContainer = document.getElementById('extractedData');
            tagsContainer.innerHTML = '';
            dataContainer.innerHTML = '';

            if (result.vaccine_name) {
                const expectedVaccine = document.getElementById('expectedVaccineName').value;
                const isMatch = expectedVaccine ? validation.nameMatch : true;
                
                const tag = document.createElement('div');
                tag.style.cssText = 'background:white;padding:10px 18px;border-radius:20px;font-size:14px;font-weight:600;display:inline-block;margin:8px 8px 8px 0;box-shadow:0 2px 8px rgba(0,0,0,0.1);';
                
                if (isMatch) {
                    tag.style.borderColor = '#4caf50';
                    tag.style.color = '#2e7d32';
                    tag.style.background = 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)';
                    tag.style.border = '2px solid #4caf50';
                    tag.innerHTML = `‚úÖ ${escapeHtml(result.vaccine_name)}`;
                } else {
                    tag.style.borderColor = '#ff9800';
                    tag.style.color = '#e65100';
                    tag.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                    tag.style.border = '2px solid #ff9800';
                    tag.innerHTML = `‚ö†Ô∏è ${escapeHtml(result.vaccine_name)}`;
                }
                
                tagsContainer.appendChild(tag);
            }

            if (!validation.nameMatch && validation.warnings.some(w => w.includes('‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°'))) {
                const warning = document.createElement('div');
                warning.style.cssText = 'background:linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);padding:20px;border-radius:12px;margin-top:16px;color:#e65100;font-size:14px;border-left:5px solid #ff9800;box-shadow:0 4px 12px rgba(255,152,0,0.2);';
                
                const expectedName = document.getElementById('expectedVaccineName').value;
                const detectedName = result.vaccine_name;
                
                warning.innerHTML = `
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                        <span style="font-size:32px;">‚ö†Ô∏è</span>
                        <div style="font-weight:700;font-size:18px;">‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</div>
                    </div>
                    
                    <div style="background:white;padding:16px;border-radius:8px;margin-bottom:12px;">
                        <div style="margin-bottom:12px;">
                            <div style="font-size:12px;color:#999;margin-bottom:4px;">üìã ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏£‡∏∞‡∏ö‡∏∏:</div>
                            <div style="font-size:15px;font-weight:700;color:#333;padding:8px 12px;background:#f5f5f5;border-radius:6px;">${escapeHtml(expectedName)}</div>
                        </div>
                        
                        <div style="text-align:center;color:#ff9800;font-size:20px;margin:8px 0;">‚áÖ</div>
                        
                        <div>
                            <div style="font-size:12px;color:#999;margin-bottom:4px;">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û:</div>
                            <div style="font-size:15px;font-weight:700;color:#333;padding:8px 12px;background:#f5f5f5;border-radius:6px;">${escapeHtml(detectedName)}</div>
                        </div>
                    </div>
                    
                    <div style="background:rgba(255,255,255,0.7);padding:12px;border-radius:8px;font-size:13px;line-height:1.6;">
                        <strong>üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong><br>
                        ‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏ó‡∏µ‡πà‡∏â‡∏µ‡∏î‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà<br>
                        ‚Ä¢ ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà<br>
                        ‚Ä¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô
                    </div>
                `;
                
                tagsContainer.appendChild(warning);
            }

            const leftTitle = document.createElement('div');
            leftTitle.style.cssText = 'font-size:16px;font-weight:700;color:#1976d2;margin:16px 0 12px 0;padding:8px 12px;background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);border-radius:8px;border-left:4px solid #2196f3;';
            leftTitle.innerHTML = 'üìÑ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å';
            dataContainer.appendChild(leftTitle);

            const mainInfoItems = [];
            if (result.vaccine_name) mainInfoItems.push({ icon: 'üíâ', label: '‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô', value: result.vaccine_name, field: 'vaccine_name' });
            if (result.vaccine_type) mainInfoItems.push({ icon: 'ü¶†', label: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó', value: result.vaccine_type, field: 'vaccine_type' });
            if (result.virus_type) mainInfoItems.push({ icon: 'üß¨', label: '‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠', value: result.virus_type, field: 'virus_type' });
            if (result.manufacturer) mainInfoItems.push({ icon: 'üè≠', label: '‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï', value: result.manufacturer, field: 'manufacturer' });
            if (result.license_no) mainInfoItems.push({ icon: 'üìú', label: '‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï', value: result.license_no, field: 'license_no' });
            if (result.dosage) mainInfoItems.push({ icon: 'üíä', label: '‡∏Ç‡∏ô‡∏≤‡∏î', value: result.dosage, field: 'dosage' });
            if (result.registration_no) mainInfoItems.push({ icon: 'üìã', label: 'REG NO.', value: result.registration_no, field: 'registration_no' });
            if (result.trade_name) mainInfoItems.push({ icon: 'üè∑Ô∏è', label: '‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠', value: result.trade_name, field: 'trade_name' });

            mainInfoItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'data-item';
                itemDiv.style.borderLeftColor = '#2196f3';
                itemDiv.innerHTML = `
                    <div class="data-row">
                        <span class="data-icon">${item.icon}</span>
                        <div class="data-content" style="flex:1;">
                            <div class="data-label">${item.label}:</div>
                            <div class="data-value" id="ocr-${item.field}">${escapeHtml(item.value)}</div>
                        </div>
                        <button onclick="editOCRField('${item.field}', '${item.label}')" class="btn-edit-field">
                            ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                    </div>
                `;
                dataContainer.appendChild(itemDiv);
            });

            if (result.serial_number || result.manufacture_date || result.expiry_date) {
                const rightTitle = document.createElement('div');
                rightTitle.style.cssText = 'font-size:16px;font-weight:700;color:#6a1b9a;margin:20px 0 12px 0;padding:8px 12px;background:linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);border-radius:8px;border-left:4px solid #9c27b0;';
                rightTitle.innerHTML = 'üî¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Batch';
                dataContainer.appendChild(rightTitle);

                const batchInfoItems = [];
                if (result.serial_number) batchInfoItems.push({ icon: 'üî¢', label: 'Ser (Batch Number)', value: result.serial_number, field: 'serial_number', highlight: true });
                if (result.manufacture_date) batchInfoItems.push({ icon: 'üìÖ', label: 'Mfg.', value: result.manufacture_date, field: 'manufacture_date', highlight: true });
                if (result.expiry_date) batchInfoItems.push({ icon: '‚è∞', label: 'Exp.', value: result.expiry_date, field: 'expiry_date', highlight: true });

                batchInfoItems.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'data-item';
                    itemDiv.style.cssText = 'padding:12px;margin-bottom:8px;background:#f3e5f5;border-radius:8px;border-left:3px solid #9c27b0;';
                    if (item.highlight) {
                        itemDiv.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                        itemDiv.style.borderLeftColor = '#f57c00';
                    }
                    itemDiv.innerHTML = `
                        <div class="data-row">
                            <span class="data-icon" style="font-size:20px;">${item.icon}</span>
                            <div class="data-content" style="flex:1;">
                                <div class="data-label">${item.label}:</div>
                                <div class="data-value" id="ocr-${item.field}" style="font-size:15px;font-weight:700;color:#d84315;">${escapeHtml(item.value)}</div>
                            </div>
                            <button onclick="editOCRField('${item.field}', '${item.label}')" class="btn-edit-field">
                                ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                        </div>
                    `;
                    dataContainer.appendChild(itemDiv);
                });
            }

            if (result.raw_text && result.raw_text.length > 0) {
                const rawTextDiv = document.createElement('details');
                rawTextDiv.style.cssText = 'margin-top:12px;padding:12px;background:#f0f4ff;border-radius:8px;cursor:pointer;';
                rawTextDiv.innerHTML = `
                    <summary style="font-weight:600;color:#2196f3;cursor:pointer;user-select:none;">
                        üìù ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å OCR
                    </summary>
                    <div style="margin-top:12px;font-size:12px;color:#555;white-space:pre-wrap;line-height:1.6;font-family:monospace;background:white;padding:12px;border-radius:6px;max-height:300px;overflow-y:auto;">
                        ${escapeHtml(result.raw_text)}
                    </div>
                `;
                dataContainer.appendChild(rawTextDiv);
            }

            document.getElementById('ocrResult').classList.add('active');
        }

        // ===== EDIT OCR FIELD =====
        function editOCRField(fieldName, fieldLabel) {
            const currentValue = document.getElementById(`ocr-${fieldName}`).textContent;
            const newValue = prompt(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ${fieldLabel}:`, currentValue);
            
            if (newValue !== null && newValue.trim() !== '') {
                document.getElementById(`ocr-${fieldName}`).textContent = newValue.trim();
                // OCR integration removed ‚Äî do not update aiAnalysisResult
                showToast(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ${fieldLabel} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, 'success');
            }
        }

        // ===== AUTO-FILL FORM =====
        function autoFillForm() {
            // OCR feature removed ‚Äî nothing to auto-fill
            showToast('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå OCR ‡∏ñ‡∏π‡∏Å‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'warning');
        }

        function copyOCRNotes() {
            showToast('‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå OCR ‡∏ñ‡∏π‡∏Å‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'warning');
        }

        function parseVaccineDate(dateStr) {
            if (!dateStr) return null;
            
            const match = dateStr.match(/(\d{1,2})\s+([A-Z]{3})\s+(\d{2,4})/i);
            if (!match) return null;
            
            const [, day, monthStr, year] = match;
            
            const monthMap = {
                'JAN': 0, 'FEB': 1, 'MAR': 2, 'APR': 3, 'MAY': 4, 'JUN': 5,
                'JUL': 6, 'AUG': 7, 'SEP': 8, 'OCT': 9, 'NOV': 10, 'DEC': 11
            };
            
            const month = monthMap[monthStr.toUpperCase()];
            if (month === undefined) return null;
            
            let fullYear = parseInt(year);
            if (fullYear < 100) {
                fullYear = fullYear < 50 ? 2000 + fullYear : 1900 + fullYear;
            }
            
            return new Date(fullYear, month, parseInt(day));
        }

        function highlightFilledFields() {
            const fields = [
                'recordBatchNumber',
                'recordNextDueDate',
                'recordNotes'
            ];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value.trim()) {
                    field.style.transition = 'all 0.3s';
                    field.style.backgroundColor = '#e8f5e9';
                    field.style.borderColor = '#4caf50';
                    
                    setTimeout(() => {
                        field.style.backgroundColor = '';
                        field.style.borderColor = '';
                    }, 2000);
                }
            });
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ===== UTILITY FUNCTIONS =====

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function validateFileUpload(file) {
            if (!file) {
                return { valid: false, error: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå' };
            }
            
            if (!ALLOWED_FILE_TYPES.includes(file.type)) {
                return { valid: false, error: '‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå JPG ‡πÅ‡∏•‡∏∞ PNG ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô' };
            }
            
            if (file.size > MAX_FILE_SIZE) {
                return { valid: false, error: '‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB' };
            }
            
            return { valid: true };
        }

        function validateDate(dateString, fieldName = '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà') {
            if (!dateString) {
                return { valid: false, error: `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏${fieldName}` };
            }
            
            const date = new Date(dateString);
            const today = new Date();
            today.setHours(23, 59, 59, 999);
            
            if (date > today) {
                return { valid: false, error: `${fieldName}‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÑ‡∏î‡πâ` };
            }
            
            return { valid: true };
        }

        function showToast(message, type = 'success') {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function setFormError(fieldId, errorMessage) {
            const formGroup = document.getElementById(fieldId).closest('.form-group');
            formGroup.classList.add('error');
            const errorElement = formGroup.querySelector('.form-error');
            if (errorElement) {
                errorElement.textContent = errorMessage;
            }
        }

        function clearFormError(fieldId) {
            const formGroup = document.getElementById(fieldId).closest('.form-group');
            formGroup.classList.remove('error');
        }

        function clearAllFormErrors() {
            document.querySelectorAll('.form-group.error').forEach(group => {
                group.classList.remove('error');
            });
        }

        async function handleFileSelect(event) {
            clearFormError('recordProofImage');
            
            const file = event.target.files[0];
            if (!file) {
                const preview = document.getElementById('imagePreviewContainer');
                const ua = document.getElementById('uploadArea');
                if (preview) preview.style.display = 'none';
                if (ua) ua.classList.remove('has-image');
                return;
            }

            const validation = validateFileUpload(file);
            if (!validation.valid) {
                setFormError('recordProofImage', validation.error);
                event.target.value = '';
                const preview = document.getElementById('imagePreviewContainer');
                const ua = document.getElementById('uploadArea');
                if (preview) preview.style.display = 'none';
                if (ua) ua.classList.remove('has-image');
                return;
            }

            currentImageFile = file;

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                const preview = document.getElementById('imagePreviewContainer');
                const ua = document.getElementById('uploadArea');
                if (preview) preview.style.display = 'block';
                if (ua) ua.classList.add('has-image');

                // hide previous OCR suggestions when new image chosen
                const ocrPanel = document.getElementById('ocrSuggestions');
                if (ocrPanel) {
                    ocrPanel.classList.add('hidden');
                    document.getElementById('ocrVaccineName').value = '';
                    document.getElementById('ocrBatchNumber').value = '';
                    document.getElementById('ocrDates').textContent = '‚Äî';
                    document.getElementById('ocrConfidence').textContent = '0%';
                }

                // (OCR removed) no-op on file select
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            document.getElementById('recordProofImage').value = '';
            document.getElementById('previewImg').src = '';
            const preview = document.getElementById('imagePreviewContainer');
            const ua = document.getElementById('uploadArea');
            if (preview) preview.style.display = 'none';
            if (ua) ua.classList.remove('has-image');
            currentImageFile = null;

            // hide OCR suggestions if any
            const ocrPanel = document.getElementById('ocrSuggestions');
            if (ocrPanel) ocrPanel.classList.add('hidden');
        }

        function openPreview() {
            const src = document.getElementById('previewImg').src;
            if (!src) return;
            // open image in a new tab for quick zoom (simple lightbox alternative)
            window.open(src, '_blank');
        }

        // ===== OCR UI Integration (frontend only) =====
        async function triggerOCR() {
            const fileInput = document.getElementById('recordProofImage');
            const file = fileInput.files[0];
            if (!file) {
                setFormError('recordProofImage', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡∏â‡∏•‡∏≤‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡πà‡∏≤‡∏ô');
                return;
            }

            // show loading state in OCR panel
            const ocrPanel = document.getElementById('ocrSuggestions');
            if (ocrPanel) {
                ocrPanel.classList.remove('hidden');
                document.getElementById('ocrVaccineName').value = '';
                document.getElementById('ocrBatchNumber').value = '';
                document.getElementById('ocrDates').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
                document.getElementById('ocrConfidence').textContent = '...';
            }

            // Try calling server-side OCR endpoint if available
            try {
                const fd = new FormData();
                fd.append('file', file);

                const resp = await fetch('/api/ocr', { method: 'POST', body: fd });
                if (!resp.ok) {
                    throw new Error('OCR service not available');
                }

                const json = await resp.json();
                // expected structure: { vaccine_name, batch_number, manufacture_date, expiry_date, confidence }
                showOCRSuggestions(json);
            } catch (err) {
                // If OCR backend not present, show a demo/mock suggestion and a toast
                showToast('OCR ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤/‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡∏•', 'warning');
                // Demo mock result to preview UI
                const demo = {
                    vaccine_name: 'Felocell 4',
                    batch_number: 'BCH-12345',
                    manufacture_date: '01/06/2025',
                    expiry_date: '01/06/2027',
                    confidence: 78
                };
                // small delay to simulate processing
                setTimeout(() => showOCRSuggestions(demo), 600);
            }
        }

        function showOCRSuggestions(data) {
            const panel = document.getElementById('ocrSuggestions');
            if (!panel) return;
            document.getElementById('ocrVaccineName').value = data.vaccine_name || '';
            document.getElementById('ocrBatchNumber').value = data.batch_number || '';
            // fill separate date suggestion inputs (expecting dd/mm/yyyy or similar)
            document.getElementById('ocrManufactureDate').value = data.manufacture_date || '';
            document.getElementById('ocrExpiryDate').value = data.expiry_date || '';
            document.getElementById('ocrConfidence').textContent = (data.confidence || 0) + '%';
            panel.classList.remove('hidden');
        }

        function parseDateToISO(dateStr) {
            if (!dateStr) return null;
            // Normalize separators
            const s = dateStr.trim().replace(/[-\.]/g, '/');
            // Attempt to match dd/mm/yyyy or dd/mm/yy
            const dmy = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
            if (dmy) {
                let day = parseInt(dmy[1], 10);
                let month = parseInt(dmy[2], 10);
                let year = parseInt(dmy[3], 10);
                if (year < 100) {
                    year += year < 50 ? 2000 : 1900;
                }
                const iso = new Date(year, month - 1, day);
                if (!isNaN(iso.getTime())) {
                    return iso.toISOString().split('T')[0];
                }
            }

            // Try ISO-like YYYY-MM-DD
            const ymd = s.match(/^(\d{4})\-(\d{1,2})\-(\d{1,2})$/);
            if (ymd) {
                const iso = new Date(parseInt(ymd[1],10), parseInt(ymd[2],10)-1, parseInt(ymd[3],10));
                if (!isNaN(iso.getTime())) return iso.toISOString().split('T')[0];
            }

            return null;
        }

        function closeOCRSuggestions() {
            const panel = document.getElementById('ocrSuggestions');
            if (panel) panel.classList.add('hidden');
        }

        function applyOCRSuggestions() {
            // Apply suggested fields into the form where appropriate
            const suggestedBatch = document.getElementById('ocrBatchNumber').value.trim();
            const suggestedVaccine = document.getElementById('ocrVaccineName').value.trim();

            if (suggestedBatch) {
                document.getElementById('recordBatchNumber').value = suggestedBatch;
                highlightFilledFields();
            }

            // If vaccine name differs from current form value, show a confirm before overwriting
            const currentVaccine = document.getElementById('recordVaccineName').value || '';
            if (suggestedVaccine && suggestedVaccine !== currentVaccine) {
                if (confirm(`‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô: "${suggestedVaccine}"\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                    document.getElementById('recordVaccineName').value = suggestedVaccine;
                }
            }

            // Apply manufacture/expiry suggestions (convert to ISO date for input[type=date] if possible)
            const ocrMfg = document.getElementById('ocrManufactureDate').value.trim();
            const ocrExp = document.getElementById('ocrExpiryDate').value.trim();
            if (ocrMfg) {
                const iso = parseDateToISO(ocrMfg);
                if (iso) document.getElementById('recordManufactureDate').value = iso;
            }
            if (ocrExp) {
                const iso2 = parseDateToISO(ocrExp);
                if (iso2) document.getElementById('recordExpiryDate').value = iso2;
            }

            closeOCRSuggestions();
            showToast('‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏à‡∏≤‡∏Å OCR ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)', 'success');
        }

        function getPetIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        function goBack() {
            window.location.href = 'your-pet.html';
        }

        function viewVaccinationRecord() {
            window.location.href = `vaccination-record.html?petId=${currentPetId}`;
        }

        // ===== LOAD PET DETAILS =====
        async function loadPetDetails() {
            currentPetId = getPetIdFromURL();
            
            if (!currentPetId) {
                window.location.href = 'your-pet.html';
                return;
            }

            try {
                showLoading();
                const response = await fetch(`${API_URL}/pets/${currentPetId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load pet');
                }

                currentPet = await response.json();
                displayPetHeader();
                await loadRecommendedVaccines();
            } catch (error) {
                console.error('Error:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
                document.getElementById('petHeader').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>
                    </div>
                `;
            } finally {
                hideLoading();
            }
        }

        function displayPetHeader() {
            const header = document.getElementById('petHeader');
            
            const birthDate = currentPet.birth_date 
                ? new Date(currentPet.birth_date).toLocaleDateString('th-TH')
                : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

            const gender = currentPet.gender === 'male' ? '‡πÄ‡∏û‡∏®‡∏ú‡∏π‡πâ' : 
                          currentPet.gender === 'female' ? '‡πÄ‡∏û‡∏®‡πÄ‡∏°‡∏µ‡∏¢' : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

            header.innerHTML = `
                <div class="pet-photo-large">
                    ${currentPet.photo_url 
                        ? `<img src="${escapeHtml(currentPet.photo_url)}" alt="${escapeHtml(currentPet.name)}" onerror="this.parentElement.innerHTML='üê±'">` 
                        : 'üê±'}
                </div>
                <div class="pet-info-full">
                    <div class="pet-name-large">${escapeHtml(currentPet.name)}</div>
                    <div class="pet-details-grid">
                        ${currentPet.breed ? `
                            <div class="detail-row">
                                <span class="detail-label">‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå:</span>
                                <span>${escapeHtml(currentPet.breed)}</span>
                            </div>
                        ` : ''}
                        <div class="detail-row">
                            <span class="detail-label">‡πÄ‡∏û‡∏®:</span>
                            <span>${gender}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î:</span>
                            <span>${birthDate}</span>
                        </div>
                        ${currentPet.color ? `
                            <div class="detail-row">
                                <span class="detail-label">‡∏™‡∏µ:</span>
                                <span>${escapeHtml(currentPet.color)}</span>
                            </div>
                        ` : ''}
                        ${currentPet.weight ? `
                            <div class="detail-row">
                                <span class="detail-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å:</span>
                                <span>${escapeHtml(currentPet.weight.toString())} ‡∏Å‡∏Å.</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

async function loadRecommendedVaccines() {
            if (!currentPet || !currentPet.birth_date) {
                document.getElementById('vaccineTimeline').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô</p>
                    </div>
                `;
                return;
            }

            try {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° cache busting parameter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                const timestamp = new Date().getTime();
                const response = await fetch(`${API_URL}/pets/${currentPetId}/recommended-vaccines?_t=${timestamp}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load vaccines');
                }

                const data = await response.json();
                
                if (data.vaccines && data.vaccines.length > 0) {
                    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ unique key (vaccine_name + dose_number + due_date)
                    const uniqueVaccines = [];
                    const seen = new Set();
                    
                    for (const vaccine of data.vaccines) {
                        const key = `${vaccine.vaccine_name}_${vaccine.dose_number || 0}_${vaccine.due_date}`;
                        if (!seen.has(key)) {
                            seen.add(key);
                            uniqueVaccines.push(vaccine);
                        }
                    }
                    
                    recommendedVaccines = uniqueVaccines;
                    displayVaccineTimeline({ ...data, vaccines: uniqueVaccines });
                } else {
                    document.getElementById('vaccineTimeline').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üíâ</div>
                            <p>${escapeHtml(data.message) || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÑ‡∏î‡πâ', 'error');
                document.getElementById('vaccineTimeline').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÑ‡∏î‡πâ</p>
                    </div>
                `;
            }
        }

        function displayVaccineTimeline(data) {
            const timeline = document.getElementById('vaccineTimeline');
            
            const ageText = calculateAgeText(data.pet_age_weeks);
            document.getElementById('petAgeInfo').style.display = 'block';
            document.getElementById('petAgeText').textContent = ageText;
            
            let html = '<div class="vaccine-timeline">';
            
            const displayVaccines = data.vaccines.slice(0, MAX_DISPLAY_VACCINES);
            
            displayVaccines.forEach(vaccine => {
                const statusClass = vaccine.status;
                const statusBadgeClass = `badge-${vaccine.status}`;
                
                let statusText = '';
                switch(vaccine.status) {
                    case 'completed': statusText = '‡∏â‡∏µ‡∏î‡πÅ‡∏•‡πâ‡∏ß'; break;
                    case 'due': statusText = '‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î'; break;
                    case 'overdue': statusText = '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î'; break;
                    case 'upcoming': statusText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ñ‡∏∂‡∏á'; break;
                }
                
                const dueDate = vaccine.due_date 
                    ? new Date(vaccine.due_date).toLocaleDateString('th-TH')
                    : '-';

                html += `
                    <div class="vaccine-item ${statusClass}">
                        <div class="vaccine-header">
                            <div class="vaccine-name">${escapeHtml(vaccine.vaccine_name)}</div>
                            <div class="vaccine-status-badge ${statusBadgeClass}">${statusText}</div>
                        </div>
                        
                        ${vaccine.description ? `
                            <div class="vaccine-description">${escapeHtml(vaccine.description)}</div>
                        ` : ''}
                        
                        <div class="vaccine-details">
                            <div><strong>‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∏:</strong> ${escapeHtml(vaccine.age_range_text) || '-'}</div>
                            <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏â‡∏µ‡∏î:</strong> ${dueDate}</div>
                            ${vaccine.is_booster ? '<div><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> üîÑ Booster</div>' : ''}
                        </div>
                        
                        <div class="vaccine-actions">
                            ${!vaccine.is_completed && (vaccine.status === 'due' || vaccine.status === 'overdue') ? `
                                <button class="btn-record" onclick="openRecordVaccineModal(${vaccine.id}, '${escapeHtml(vaccine.vaccine_name).replace(/'/g, "\\'")}')">
                                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            timeline.innerHTML = html;
        }

        function calculateAgeText(weeks) {
            const years = Math.floor(weeks / WEEKS_PER_YEAR);
            const remainingWeeks = weeks % WEEKS_PER_YEAR;
            const months = Math.floor(remainingWeeks / WEEKS_PER_MONTH);
            
            let ageText = '';
            if (years > 0) {
                ageText = `${years} ‡∏õ‡∏µ`;
                if (months > 0) ageText += ` ${months} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
            } else if (months > 0) {
                ageText = `${months} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
            } else {
                ageText = `${weeks} ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå`;
            }
            
            return ageText;
        }

        function openRecordVaccineModal(scheduleId, vaccineName) {
            clearAllFormErrors();
            document.getElementById('recordScheduleId').value = scheduleId;
            document.getElementById('recordVaccineName').value = vaccineName;
            document.getElementById('expectedVaccineName').value = vaccineName;
            document.getElementById('recordVaccinationDate').value = new Date().toISOString().split('T')[0];
            const preview = document.getElementById('imagePreviewContainer');
            const ua = document.getElementById('uploadArea');
            if (preview) preview.style.display = 'none';
            if (ua) ua.classList.remove('has-image');
            // OCR UI removed
            document.getElementById('recordVaccineModal').classList.add('active');
            
            setTimeout(() => {
                document.getElementById('recordVaccinationDate').focus();
            }, 100);
        }

        function closeRecordVaccineModal() {
            document.getElementById('recordVaccineModal').classList.remove('active');
            document.getElementById('recordVaccineForm').reset();
            clearAllFormErrors();
            removeImage();
        }

        async function handleRecordVaccination(event) {
            event.preventDefault();
            clearAllFormErrors();
            
            const vaccinationDate = document.getElementById('recordVaccinationDate').value;
            const dateValidation = validateDate(vaccinationDate, '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏â‡∏µ‡∏î');
            if (!dateValidation.valid) {
                setFormError('recordVaccinationDate', dateValidation.error);
                return;
            }
            
            const fileInput = document.getElementById('recordProofImage');
            const file = fileInput.files[0];
            const fileValidation = validateFileUpload(file);
            if (!fileValidation.valid) {
                setFormError('recordProofImage', fileValidation.error);
                return;
            }
            
            // OCR removed: skip OCR-based mismatch warning
            
            if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô?')) {
                return;
            }
            
            const formData = new FormData();
            formData.append('vaccine_name', document.getElementById('recordVaccineName').value);
            formData.append('vaccination_date', vaccinationDate);
            formData.append('veterinarian', document.getElementById('recordVeterinarian').value.trim());
            formData.append('clinic_name', document.getElementById('recordClinicName').value.trim());
            formData.append('batch_number', document.getElementById('recordBatchNumber').value.trim());
            formData.append('notes', document.getElementById('recordNotes').value.trim());
            formData.append('next_due_date', document.getElementById('recordNextDueDate').value);
            formData.append('manufacture_date', document.getElementById('recordManufactureDate').value);
            formData.append('expiry_date', document.getElementById('recordExpiryDate').value);
            formData.append('schedule_id', document.getElementById('recordScheduleId').value);
            formData.append('proof', file);
            
            // OCR removed: no ai_analysis to append
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            
            try {
                showLoading();
                
                const response = await fetch(`${API_URL}/pets/${currentPetId}/vaccinations`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    closeRecordVaccineModal();
                    await loadRecommendedVaccines();
                } else {
                    const data = await response.json();
                    throw new Error(data.error || data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
            } finally {
                hideLoading();
                submitBtn.disabled = false;
                submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô';
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('recordVaccineModal');
                if (modal.classList.contains('active')) {
                    closeRecordVaccineModal();
                }
            }
        });

        document.getElementById('recordVaccineModal').addEventListener('click', (e) => {
            if (e.target.id === 'recordVaccineModal') {
                closeRecordVaccineModal();
            }
        });

        document.querySelectorAll('#recordVaccineForm input, #recordVaccineForm textarea').forEach(input => {
            input.addEventListener('input', function() {
                clearFormError(this.id);
            });
        });

        // OCR worker removed; no beforeunload cleanup required

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            loadPetDetails();
        });
    </script>

    <!-- Load Scripts -->
    <script src="/js/navbar.js"></script>
    <script src="/js/config.js"></script>
    <script src="/js/profile-dropdown.js"></script>
    <script src="/js/auth-common.js"></script>
</body>
</html>